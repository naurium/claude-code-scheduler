$$logDir = "${LOG_DIR}"
$$logFile = Join-Path $$logDir "claude_scheduler.log"

if (!(Test-Path $$logDir)) {
    New-Item -ItemType Directory -Path $$logDir -Force | Out-Null
}

$$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
Add-Content -Path $$logFile -Value "$$timestamp - Starting scheduled task"

# Run claude through WSL
$$fullCommand = "${COMMAND}"
Add-Content -Path $$logFile -Value "Running command: $$fullCommand"

try {
    # Extract command for better error reporting
    $$cmdParts = $$fullCommand -split ' ', 2
    $$cmdToCheck = $$cmdParts[0]
    
    # Run through WSL with expanded PATH and command checking
    $$bashScript = @"
export PATH='~/.local/bin:~/.npm-global/bin:~/.yarn/bin:/usr/local/bin:/usr/bin:/bin:$$PATH'
CMD_TO_CHECK='$$cmdToCheck'
if command -v \`$$CMD_TO_CHECK &> /dev/null || [[ -x \`$$CMD_TO_CHECK ]]; then
    ${COMMAND}
else
    echo "ERROR: Command not found or not executable: \`$$CMD_TO_CHECK"
    echo "Full command was: ${COMMAND}"
    exit 1
fi
"@
    
    $$output = wsl bash -c $$bashScript 2>&1
    Add-Content -Path $$logFile -Value $$output
    
    if ($$LASTEXITCODE -eq 0) {
        Add-Content -Path $$logFile -Value "$$timestamp - Task completed"
    } else {
        throw "Command failed with exit code $$LASTEXITCODE"
    }
    
    # Send success notification if configured
    $$ntfyTopic = "${NTFY_TOPIC}"
    if ($$ntfyTopic) {
        $$time = Get-Date -Format "HH:mm"
        try {
            Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                -Body "✅ Claude session refreshed at $$time" | Out-Null
        } catch {
            Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
        }
    }
} catch {
    Add-Content -Path $$logFile -Value "$$timestamp - ERROR: Failed to run claude through WSL"
    Add-Content -Path $$logFile -Value "$$timestamp - Make sure WSL is installed and claude is configured in WSL"
    Add-Content -Path $$logFile -Value "Error details: $$_"
    
    # Send error notification if configured
    $$ntfyTopic = "${NTFY_TOPIC}"
    if ($$ntfyTopic) {
        try {
            Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                -Body "⚠️ Claude scheduler failed - check logs" `
                -Headers @{"Priority"="high"} | Out-Null
        } catch {
            Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
        }
    }
}

Add-Content -Path $$logFile -Value "---"