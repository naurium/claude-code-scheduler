$$logDir = "${LOG_DIR}"
$$logFile = Join-Path $$logDir "claude_scheduler.log"

if (!(Test-Path $$logDir)) {
    New-Item -ItemType Directory -Path $$logDir -Force | Out-Null
}

$$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
Add-Content -Path $$logFile -Value "$$timestamp - Starting scheduled task"

# Run claude through WSL
$$fullCommand = "${COMMAND}"
Add-Content -Path $$logFile -Value "Running command: $$fullCommand"

try {
    # Extract command for better error reporting
    $$cmdParts = $$fullCommand -split ' ', 2
    $$cmdToCheck = $$cmdParts[0]
    
    # Run through WSL with expanded PATH and command checking
    $$bashScript = @"
export PATH='~/.local/bin:~/.npm-global/bin:~/.yarn/bin:/usr/local/bin:/usr/bin:/bin:$$PATH'

# Set working directory (default to home if not specified or if set to ~)
WORKING_DIR='${WORKING_DIR_VALUE}'
if [[ -z \`$$WORKING_DIR ]] || [[ \`$$WORKING_DIR == "~" ]]; then
    WORKING_DIR=\`$$HOME
else
    # Expand tilde if present at the start of the path
    WORKING_DIR="\`$${WORKING_DIR/#\~/$HOME}"
fi

echo "Changing to directory: \`$$WORKING_DIR"
cd \`$$WORKING_DIR || {
    echo "ERROR: Cannot change to directory: \`$$WORKING_DIR"
    exit 1
}
echo "Current directory: \`$$(pwd)"

CMD_TO_CHECK='$$cmdToCheck'
if command -v \`$$CMD_TO_CHECK &> /dev/null || [[ -x \`$$CMD_TO_CHECK ]]; then
    ${COMMAND}
else
    echo "ERROR: Command not found or not executable: \`$$CMD_TO_CHECK"
    echo "Full command was: ${COMMAND}"
    exit 1
fi
"@
    
    $$output = wsl bash -c $$bashScript 2>&1
    Add-Content -Path $$logFile -Value $$output
    
    if ($$LASTEXITCODE -eq 0) {
        Add-Content -Path $$logFile -Value "$$timestamp - Task completed successfully"
        
        # Send success notification if configured
        $$ntfyTopic = "${NTFY_TOPIC}"
        if ($$ntfyTopic) {
            $$time = Get-Date -Format "HH:mm"
            try {
                Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                    -Body "‚úÖ Claude session refreshed at $$time" | Out-Null
            } catch {
                Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
            }
        }
    } else {
        Add-Content -Path $$logFile -Value "$$timestamp - Task failed with exit code $$LASTEXITCODE"
        
        # Send error notification if configured
        $$ntfyTopic = "${NTFY_TOPIC}"
        if ($$ntfyTopic) {
            # Check for specific error types
            if ($$output -match "Invalid API key") {
                try {
                    Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                        -Body "üîë Claude API error - please run /login" `
                        -Headers @{"Priority"="high"} | Out-Null
                } catch {
                    Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
                }
            } else {
                try {
                    Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                        -Body "‚ö†Ô∏è Claude scheduler failed - check logs (exit code: $$LASTEXITCODE)" `
                        -Headers @{"Priority"="high"} | Out-Null
                } catch {
                    Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
                }
            }
        }
    }
} catch {
    Add-Content -Path $$logFile -Value "$$timestamp - ERROR: Failed to run claude through WSL"
    Add-Content -Path $$logFile -Value "$$timestamp - Make sure WSL is installed and claude is configured in WSL"
    Add-Content -Path $$logFile -Value "Error details: $$_"
    
    # Send error notification if configured
    $$ntfyTopic = "${NTFY_TOPIC}"
    if ($$ntfyTopic) {
        try {
            Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                -Body "‚ö†Ô∏è Claude scheduler failed - WSL error" `
                -Headers @{"Priority"="high"} | Out-Null
        } catch {
            Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
        }
    }
}

Add-Content -Path $$logFile -Value "---"