$$logDir = "${LOG_DIR}"
$$logFile = Join-Path $$logDir "claude_scheduler.log"

if (!(Test-Path $$logDir)) {
    New-Item -ItemType Directory -Path $$logDir -Force | Out-Null
}

$$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
Add-Content -Path $$logFile -Value "$$timestamp - Starting scheduled task"

# Run claude through WSL
try {
    $$output = wsl ${COMMAND} 2>&1
    Add-Content -Path $$logFile -Value $$output
    Add-Content -Path $$logFile -Value "$$timestamp - Task completed"
    
    # Send success notification if configured
    $$ntfyTopic = "${NTFY_TOPIC}"
    if ($$ntfyTopic) {
        $$time = Get-Date -Format "HH:mm"
        try {
            Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                -Body "✅ Claude session refreshed at $$time" | Out-Null
        } catch {
            Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
        }
    }
} catch {
    Add-Content -Path $$logFile -Value "$$timestamp - ERROR: Failed to run claude through WSL"
    Add-Content -Path $$logFile -Value "$$timestamp - Make sure WSL is installed and claude is configured in WSL"
    Add-Content -Path $$logFile -Value "Error details: $$_"
    
    # Send error notification if configured
    $$ntfyTopic = "${NTFY_TOPIC}"
    if ($$ntfyTopic) {
        try {
            Invoke-RestMethod -Uri "https://ntfy.sh/$$ntfyTopic" -Method Post `
                -Body "⚠️ Claude scheduler failed - check logs" `
                -Headers @{"Priority"="high"} | Out-Null
        } catch {
            Add-Content -Path $$logFile -Value "Failed to send notification: $$_"
        }
    }
}

Add-Content -Path $$logFile -Value "---"